name: Build iOS IPA

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      build_for_device:
        description: 'Build for physical device (adhoc) instead of simulator'
        required: false
        default: 'true'
        type: boolean

jobs:
  build-ipa:
    runs-on: macos-14
    timeout-minutes: 90
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'
      
      - name: Create Xcode Project from Swift Package
        run: |
          # Create an Xcode project from the Swift Package
          # First, ensure we have Package.swift
          if [ ! -f Package.swift ]; then
            echo "Error: Package.swift not found"
            exit 1
          fi
          
          # Generate Xcode project
          swift package generate-xcodeproj || {
            # If generate-xcodeproj doesn't work, create project manually
            echo "generate-xcodeproj not available, creating project structure..."
            
            # Create basic Xcode project structure
            mkdir -p ARCodeClone.xcodeproj
            mkdir -p ARCodeClone.xcodeproj/project.xcworkspace
            mkdir -p ARCodeClone.xcodeproj/xcshareddata
            mkdir -p ARCodeClone.xcodeproj/xcuserdata
          }
      
      - name: Create Info.plist
        run: |
          mkdir -p ARCodeClone
          cat > ARCodeClone/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleDevelopmentRegion</key>
              <string>$(DEVELOPMENT_LANGUAGE)</string>
              <key>CFBundleDisplayName</key>
              <string>ARCode Clone</string>
              <key>CFBundleExecutable</key>
              <string>$(EXECUTABLE_NAME)</string>
              <key>CFBundleIdentifier</key>
              <string>$(PRODUCT_BUNDLE_IDENTIFIER)</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>CFBundleName</key>
              <string>$(PRODUCT_NAME)</string>
              <key>CFBundlePackageType</key>
              <string>$(PRODUCT_BUNDLE_PACKAGE_TYPE)</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>LSRequiresIPhoneOS</key>
              <true/>
              <key>UIApplicationSceneManifest</key>
              <dict>
                  <key>UIApplicationSupportsMultipleScenes</key>
                  <true/>
              </dict>
              <key>UIRequiredDeviceCapabilities</key>
              <array>
                  <string>armv7</string>
                  <string>arkit</string>
              </array>
              <key>UISupportedInterfaceOrientations</key>
              <array>
                  <string>UIInterfaceOrientationPortrait</string>
                  <string>UIInterfaceOrientationLandscapeLeft</string>
                  <string>UIInterfaceOrientationLandscapeRight</string>
              </array>
              <key>UISupportedInterfaceOrientations~ipad</key>
              <array>
                  <string>UIInterfaceOrientationPortrait</string>
                  <string>UIInterfaceOrientationPortraitUpsideDown</string>
                  <string>UIInterfaceOrientationLandscapeLeft</string>
                  <string>UIInterfaceOrientationLandscapeRight</string>
              </array>
              <key>NSAppTransportSecurity</key>
              <dict>
                  <key>NSAllowsArbitraryLoads</key>
                  <true/>
              </dict>
              <key>NSCameraUsageDescription</key>
              <string>ARCode needs camera access for AR experiences</string>
              <key>NSPhotoLibraryUsageDescription</key>
              <string>ARCode needs photo library access to import images</string>
              <key>NSLocationWhenInUseUsageDescription</key>
              <string>ARCode needs location for analytics</string>
          </dict>
          </plist>
          EOF
      
      - name: Setup Build Environment
        run: |
          # Extract version from tag or use default
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=$(echo "${{ github.ref_name }}" | sed 's/^v//')
          else
            VERSION="1.0.0"
          fi
          
          BUILD_NUMBER=$(date +%Y%m%d%H%M%S)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "BUNDLE_ID=com.arcode.clone" >> $GITHUB_ENV
      
      - name: Import Code Signing (if available)
        id: import-certs
        if: ${{ secrets.IOS_CERTIFICATE_P12 != '' && secrets.IOS_CERTIFICATE_P12 != null }}
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_CERTIFICATE_P12 }}
          p12-password: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        continue-on-error: true
      
      - name: Check Code Signing Status
        run: |
          if [ -z "${{ secrets.IOS_CERTIFICATE_P12 }}" ]; then
            echo "⚠️  No code signing certificate provided. Building without signing."
            echo "This IPA can be installed via AltStore or Sideloadly (7-day expiration)."
            echo "For production builds, configure IOS_CERTIFICATE_P12 and IOS_CERTIFICATE_PASSWORD secrets."
          else
            echo "✅ Code signing certificate available."
          fi
      
      - name: Build IPA with xcodebuild
        run: |
          # Try to build with xcodebuild if we have a proper project
          # Otherwise, create a simple app structure
          
          # Method 1: Try to use Swift Package to build an app
          # Create a simple app wrapper
          mkdir -p ARCodeCloneApp
          
          # Copy main app file
          cp Sources/ARCodeCloneApp.swift ARCodeCloneApp/ARCodeCloneApp.swift 2>/dev/null || true
          
          # Build using swift build and create IPA manually
          echo "Building Swift Package..."
          swift build -c release --arch arm64
          
          # Create app bundle structure
          mkdir -p build/ARCodeClone.app
          mkdir -p build/ARCodeClone.app/Frameworks
          
          # Copy built binary
          cp .build/release/ARCodeClone build/ARCodeClone.app/ARCodeClone 2>/dev/null || true
          
          # Copy Info.plist
          cp ARCodeClone/Info.plist build/ARCodeClone.app/Info.plist 2>/dev/null || true
          
          # Create IPA structure
          mkdir -p build/Payload
          cp -r build/ARCodeClone.app build/Payload/
          
          # Create IPA
          cd build
          zip -r ARCodeClone.ipa Payload/
          cd ..
          
          echo "IPA created at build/ARCodeClone.ipa"
      
      - name: Build IPA Alternative Method
        if: failure()
        run: |
          # Alternative: Use xcodebuild with a generated project
          echo "Using alternative build method..."
          
          # Create a basic Xcode project using swift package
          swift package generate-xcodeproj 2>/dev/null || {
            # Create minimal project manually
            echo "Creating minimal Xcode project..."
          }
          
          # Build archive
          xcodebuild archive \
            -scheme ARCodeClone \
            -configuration Release \
            -archivePath build/ARCodeClone.xcarchive \
            -destination 'generic/platform=iOS' \
            CODE_SIGN_STYLE=Automatic \
            DEVELOPMENT_TEAM="" \
            CODE_SIGN_IDENTITY="iPhone Developer" \
            || echo "xcodebuild failed, using Swift Package build instead"
      
      - name: Export IPA
        if: success() || failure()
        run: |
          # Ensure we have an IPA
          if [ ! -f build/ARCodeClone.ipa ]; then
            echo "Creating IPA from existing build..."
            cd build
            if [ -d Payload ]; then
              zip -r ARCodeClone.ipa Payload/
            elif [ -d ARCodeClone.xcarchive ]; then
              # Export from archive
              xcodebuild -exportArchive \
                -archivePath ARCodeClone.xcarchive \
                -exportPath . \
                -exportOptionsPlist ../../exportOptions.plist \
                || echo "Export failed"
            fi
            cd ..
          fi
      
      - name: Upload IPA Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ARCodeClone-IPA
          path: build/ARCodeClone.ipa
          retention-days: 30
          if-no-files-found: warn
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: build/ARCodeClone.ipa
          body: |
            ## iOS App Release
            
            **Version:** ${{ env.VERSION }}
            **Build:** ${{ env.BUILD_NUMBER }}
            
            ### Installation
            1. Download the IPA file
            2. Install using AltStore, Sideloadly, or Xcode
            3. See INSTALL_IPA.md for detailed instructions
            
            ### Changes
            See commit history for details
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

