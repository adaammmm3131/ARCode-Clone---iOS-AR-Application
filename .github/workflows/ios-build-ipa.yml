name: Build iOS IPA

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      build_for_device:
        description: 'Build for physical device (adhoc) instead of simulator'
        required: false
        default: 'true'
        type: boolean

jobs:
  build-ipa:
    runs-on: macos-14
    timeout-minutes: 90
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'
      
      - name: Create Xcode Project from Swift Package
        run: |
          # Create an Xcode project from the Swift Package
          # First, ensure we have Package.swift
          if [ ! -f Package.swift ]; then
            echo "Error: Package.swift not found"
            exit 1
          fi
          
          # Generate Xcode project
          swift package generate-xcodeproj || {
            # If generate-xcodeproj doesn't work, create project manually
            echo "generate-xcodeproj not available, creating project structure..."
            
            # Create basic Xcode project structure
            mkdir -p ARCodeClone.xcodeproj
            mkdir -p ARCodeClone.xcodeproj/project.xcworkspace
            mkdir -p ARCodeClone.xcodeproj/xcshareddata
            mkdir -p ARCodeClone.xcodeproj/xcuserdata
          }
      
      - name: Create Info.plist
        run: |
          mkdir -p ARCodeClone
          cat > ARCodeClone/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleDevelopmentRegion</key>
              <string>$(DEVELOPMENT_LANGUAGE)</string>
              <key>CFBundleDisplayName</key>
              <string>ARCode Clone</string>
              <key>CFBundleExecutable</key>
              <string>$(EXECUTABLE_NAME)</string>
              <key>CFBundleIdentifier</key>
              <string>$(PRODUCT_BUNDLE_IDENTIFIER)</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>CFBundleName</key>
              <string>$(PRODUCT_NAME)</string>
              <key>CFBundlePackageType</key>
              <string>$(PRODUCT_BUNDLE_PACKAGE_TYPE)</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>LSRequiresIPhoneOS</key>
              <true/>
              <key>UIApplicationSceneManifest</key>
              <dict>
                  <key>UIApplicationSupportsMultipleScenes</key>
                  <true/>
              </dict>
              <key>UIRequiredDeviceCapabilities</key>
              <array>
                  <string>armv7</string>
                  <string>arkit</string>
              </array>
              <key>UISupportedInterfaceOrientations</key>
              <array>
                  <string>UIInterfaceOrientationPortrait</string>
                  <string>UIInterfaceOrientationLandscapeLeft</string>
                  <string>UIInterfaceOrientationLandscapeRight</string>
              </array>
              <key>UISupportedInterfaceOrientations~ipad</key>
              <array>
                  <string>UIInterfaceOrientationPortrait</string>
                  <string>UIInterfaceOrientationPortraitUpsideDown</string>
                  <string>UIInterfaceOrientationLandscapeLeft</string>
                  <string>UIInterfaceOrientationLandscapeRight</string>
              </array>
              <key>NSAppTransportSecurity</key>
              <dict>
                  <key>NSAllowsArbitraryLoads</key>
                  <true/>
              </dict>
              <key>NSCameraUsageDescription</key>
              <string>ARCode needs camera access for AR experiences</string>
              <key>NSPhotoLibraryUsageDescription</key>
              <string>ARCode needs photo library access to import images</string>
              <key>NSLocationWhenInUseUsageDescription</key>
              <string>ARCode needs location for analytics</string>
          </dict>
          </plist>
          EOF
      
      - name: Setup Build Environment
        run: |
          # Extract version from tag or use default
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=$(echo "${{ github.ref_name }}" | sed 's/^v//')
          else
            VERSION="1.0.0"
          fi
          
          BUILD_NUMBER=$(date +%Y%m%d%H%M%S)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "BUNDLE_ID=com.arcode.clone" >> $GITHUB_ENV
      
      - name: Check Code Signing Status
        id: check-signing
        run: |
          if [ -n "${{ secrets.IOS_CERTIFICATE_P12 }}" ] && [ "${{ secrets.IOS_CERTIFICATE_P12 }}" != "" ]; then
            echo "✅ Code signing certificate available."
            echo "has_cert=true" >> $GITHUB_OUTPUT
          else
            echo "⚠️  No code signing certificate provided. Building without signing."
            echo "This IPA can be installed via AltStore or Sideloadly (7-day expiration)."
            echo "For production builds, configure IOS_CERTIFICATE_P12 and IOS_CERTIFICATE_PASSWORD secrets."
            echo "has_cert=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Import Code Signing (if available)
        id: import-certs
        if: steps.check-signing.outputs.has_cert == 'true'
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_CERTIFICATE_P12 }}
          p12-password: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        continue-on-error: true
      
      - name: Build for iOS Simulator (for testing)
        run: |
          echo "Building Swift Package for iOS Simulator..."
          # Build for iOS Simulator (arm64)
          xcrun swift build \
            -c release \
            -Xswiftc -sdk \
            -Xswiftc $(xcrun --show-sdk-path --sdk iphonesimulator) \
            -Xswiftc -target \
            -Xswiftc arm64-apple-ios16.0-simulator \
            --arch arm64 || {
              echo "iOS Simulator build failed, trying alternative method..."
              # Alternative: Build using xcodebuild if we can create a project
              swift package resolve
              # Just verify the package compiles
              swift build -c release --arch arm64 || echo "Build verification failed"
            }
      
      - name: Build IPA for Device
        run: |
          echo "Building for iOS Device (arm64)..."
          
          # Create a minimal Xcode project structure
          mkdir -p build/ARCodeClone.app
          
          # Use xcodebuild to build for iOS device
          # First, try to generate Xcode project
          swift package generate-xcodeproj 2>/dev/null || {
            echo "generate-xcodeproj not available, using manual build method..."
            
            # Build using xcodebuild with SDK iOS
            xcrun xcodebuild \
              -scheme ARCodeClone \
              -configuration Release \
              -sdk iphoneos \
              -destination 'generic/platform=iOS' \
              -archivePath build/ARCodeClone.xcarchive \
              archive \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              DEVELOPMENT_TEAM="" \
              2>/dev/null || echo "xcodebuild archive failed, will use alternative method"
          }
          
          # Alternative: Create IPA manually from Swift Package build
          if [ ! -d build/ARCodeClone.xcarchive ]; then
            echo "Creating IPA manually from package structure..."
            
            # Build Swift Package for iOS device
            xcrun swift build \
              -c release \
              -Xswiftc -sdk \
              -Xswiftc $(xcrun --show-sdk-path --sdk iphoneos) \
              -Xswiftc -target \
              -Xswiftc arm64-apple-ios16.0 \
              --arch arm64 || {
                echo "⚠️  Device build failed. IPA will be for simulator only."
                echo "Note: To build for device, you need a proper Xcode project or code signing."
              }
          fi
      
      - name: Create IPA from Archive or Package
        run: |
          mkdir -p build/Payload
          
          # Method 1: Export from xcodebuild archive
          if [ -d build/ARCodeClone.xcarchive ]; then
            echo "Exporting IPA from xcodebuild archive..."
            xcodebuild -exportArchive \
              -archivePath build/ARCodeClone.xcarchive \
              -exportPath build \
              -exportOptionsPlist exportOptions.plist \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              2>/dev/null || echo "Export from archive failed"
          fi
          
          # Method 2: Create IPA manually from Swift Package
          if [ ! -f build/ARCodeClone.ipa ] && [ -f .build/release/ARCodeClone ]; then
            echo "Creating IPA from Swift Package build..."
            
            # Create app bundle
            mkdir -p build/Payload/ARCodeClone.app
            cp .build/release/ARCodeClone build/Payload/ARCodeClone.app/ARCodeClone
            
            # Copy Info.plist if exists
            if [ -f ARCodeClone/Info.plist ]; then
              cp ARCodeClone/Info.plist build/Payload/ARCodeClone.app/Info.plist
            fi
            
            # Create IPA
            cd build
            zip -r ARCodeClone.ipa Payload/
            cd ..
            
            echo "✅ IPA created at build/ARCodeClone.ipa"
          fi
          
          # Verify IPA exists
          if [ -f build/ARCodeClone.ipa ]; then
            echo "✅ IPA file created successfully"
            ls -lh build/ARCodeClone.ipa
          else
            echo "⚠️  IPA file not created. Check build logs for errors."
            exit 1
          fi
      
      - name: Export IPA
        if: success() || failure()
        run: |
          # Ensure we have an IPA
          if [ ! -f build/ARCodeClone.ipa ]; then
            echo "Creating IPA from existing build..."
            cd build
            if [ -d Payload ]; then
              zip -r ARCodeClone.ipa Payload/
            elif [ -d ARCodeClone.xcarchive ]; then
              # Export from archive
              xcodebuild -exportArchive \
                -archivePath ARCodeClone.xcarchive \
                -exportPath . \
                -exportOptionsPlist ../../exportOptions.plist \
                || echo "Export failed"
            fi
            cd ..
          fi
      
      - name: Upload IPA Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ARCodeClone-IPA
          path: build/ARCodeClone.ipa
          retention-days: 30
          if-no-files-found: warn
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: build/ARCodeClone.ipa
          body: |
            ## iOS App Release
            
            **Version:** ${{ env.VERSION }}
            **Build:** ${{ env.BUILD_NUMBER }}
            
            ### Installation
            1. Download the IPA file
            2. Install using AltStore, Sideloadly, or Xcode
            3. See INSTALL_IPA.md for detailed instructions
            
            ### Changes
            See commit history for details
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

