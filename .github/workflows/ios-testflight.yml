name: iOS TestFlight Deployment

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
    paths:
      - 'Sources/**'
      - '*.xcodeproj/**'
      - '*.xcworkspace/**'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
      build_number:
        description: 'Build number'
        required: true

jobs:
  build-and-deploy:
    runs-on: macos-14
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'
      
      - name: Setup environment
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
            echo "BUILD_NUMBER=${{ github.event.inputs.build_number }}" >> $GITHUB_ENV
          else
            # Extract version from tag
            VERSION=$(echo ${{ github.ref_name }} | sed 's/^v//')
            BUILD_NUMBER=$(date +%Y%m%d%H%M%S)
            echo "VERSION=$VERSION" >> $GITHUB_ENV
            echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          fi
      
      - name: Import Code Signing Certificate
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_CERTIFICATE_P12 }}
          p12-password: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
      
      - name: Install Provisioning Profile
        uses: apple-actions/download-provisioning-profiles@v1
        with:
          bundle-id: ${{ secrets.IOS_BUNDLE_ID }}
          issuer-id: ${{ secrets.IOS_ISSUER_ID }}
          api-key-id: ${{ secrets.IOS_API_KEY_ID }}
          api-private-key: ${{ secrets.IOS_API_KEY }}
      
      - name: Increment build number
        run: |
          # Update Info.plist or project settings
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" Info.plist || true
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" Info.plist || true
      
      - name: Build archive
        run: |
          xcodebuild archive \
            -scheme ARCodeClone \
            -configuration Release \
            -archivePath build/ARCodeClone.xcarchive \
            -destination 'generic/platform=iOS' \
            CODE_SIGN_STYLE=Automatic \
            CODE_SIGN_IDENTITY="iPhone Distribution" \
            PROVISIONING_PROFILE_SPECIFIER="match AppStore ar-code.com" \
            DEVELOPMENT_TEAM=${{ secrets.IOS_TEAM_ID }}
      
      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath build/ARCodeClone.xcarchive \
            -exportPath build \
            -exportOptionsPlist exportOptions.plist
      
      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: build/ARCodeClone.ipa
          issuer-id: ${{ secrets.IOS_ISSUER_ID }}
          api-key-id: ${{ secrets.IOS_API_KEY_ID }}
          api-private-key: ${{ secrets.IOS_API_KEY }}
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: Release v${{ env.VERSION }}
          body: |
            iOS App Release v${{ env.VERSION }}
            Build: ${{ env.BUILD_NUMBER }}
            
            ## Changes
            - See commit history for details
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

