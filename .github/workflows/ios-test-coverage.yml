name: iOS Test Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  coverage:
    runs-on: macos-14
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'
      
      - name: Cache Swift packages
        uses: actions/cache@v4
        id: swift-package-cache
        with:
          path: |
            .build
            ~/.swiftpm
          key: ${{ runner.os }}-swift-${{ hashFiles('Package.swift') }}-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-swift-${{ hashFiles('Package.swift') }}-
            ${{ runner.os }}-swift-
      
      - name: Set iOS SDK Environment
        run: |
          export IOS_SDK=$(xcrun --show-sdk-path --sdk iphonesimulator)
          export SDKROOT="$IOS_SDK"
          echo "IOS_SDK=$IOS_SDK" >> $GITHUB_ENV
          echo "SDKROOT=$SDKROOT" >> $GITHUB_ENV
          echo "iOS Simulator SDK: $IOS_SDK"
      
      - name: Resolve Swift Package Dependencies
        env:
          SDKROOT: ${{ env.IOS_SDK }}
          SWIFT_TARGET_TRIPLE: arm64-apple-ios16.0-simulator
        run: |
          if [ "${{ steps.swift-package-cache.outputs.cache-hit }}" == "true" ]; then
            echo "âœ… Cache hit! Using cached dependencies"
          else
            echo "ðŸ“¦ Cache miss. Resolving dependencies..."
          fi
          
          # Force iOS target for manifest compilation
          export SDKROOT="${{ env.IOS_SDK }}"
          export SWIFT_TARGET_TRIPLE="arm64-apple-ios16.0-simulator"
          export DEVELOPER_DIR="/Applications/Xcode_15.2.app/Contents/Developer"
          
          # Try to resolve with explicit SDK
          # If this fails, swift build will handle dependency resolution  
          xcrun --sdk iphonesimulator swift package resolve || \
          echo "âš ï¸  swift package resolve failed, dependencies will be resolved during build"
      
      - name: Run tests with coverage for iOS Simulator
        env:
          SDKROOT: ${{ env.IOS_SDK }}
        run: |
          echo "Running tests for iOS Simulator with code coverage..."
          
          # Get iOS Simulator SDK path
          IOS_SDK="${{ env.IOS_SDK }}"
          echo "Using iOS SDK: $IOS_SDK"
          echo "SDKROOT: $SDKROOT"
          
          # Build and test with explicit iOS Simulator target
          export SDKROOT="$IOS_SDK"
          xcrun swift test \
            --enable-code-coverage \
            --parallel \
            -Xswiftc -sdk \
            -Xswiftc "$IOS_SDK" \
            -Xswiftc -target \
            -Xswiftc arm64-apple-ios16.0-simulator \
            -Xswiftc -Xcc \
            -Xswiftc -isysroot \
            -Xswiftc "$IOS_SDK" \
            --arch arm64
      
      - name: Generate coverage report
        run: |
          # Find the test binary (iOS Simulator or macOS)
          TEST_BINARY=$(find .build -name "ARCodeClonePackageTests" -type f 2>/dev/null | head -1)
          
          if [ -z "$TEST_BINARY" ]; then
            # Try alternative path
            TEST_BINARY=$(find .build -path "*/ARCodeCloneTests*" -type f -perm +111 2>/dev/null | head -1)
          fi
          
          if [ -n "$TEST_BINARY" ]; then
            echo "Found test binary at: $TEST_BINARY"
            xcrun llvm-cov export-format lcov \
              -instr-profile .build/debug/codecov/default.profdata \
              "$TEST_BINARY" \
              -ignore-filename-regex=".*Tests.*" \
              > coverage.lcov || echo "Coverage generation failed, continuing..."
          else
            echo "âš ï¸  Test binary not found, skipping coverage report"
            echo "# Coverage report not available" > coverage.lcov
          fi
      
      - name: Check coverage threshold
        run: |
          # Parse coverage and check if >= 80%
          coverage=$(lcov --summary coverage.lcov 2>/dev/null | grep lines | awk '{print $2}' | sed 's/%//')
          if (( $(echo "$coverage < 80" | bc -l) )); then
            echo "Coverage is ${coverage}%, below 80% threshold"
            exit 1
          fi
          echo "Coverage is ${coverage}%, above 80% threshold âœ“"
        continue-on-error: true
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.lcov
          flags: ios
          fail_ci_if_error: false







