name: iOS Tests with Simulator

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'Sources/**'
      - 'Tests/**'
      - 'Package.swift'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'Sources/**'
      - 'Tests/**'
      - 'Package.swift'
  workflow_dispatch:

jobs:
  test:
    runs-on: macos-14
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'
      
      - name: Select Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer
      
      - name: Show Xcode version
        run: |
          xcodebuild -version
          xcrun simctl list devices available
      
      - name: Cache Swift packages
        uses: actions/cache@v4
        id: swift-package-cache
        with:
          path: |
            .build
            ~/.swiftpm
          key: ${{ runner.os }}-swift-${{ hashFiles('Package.swift') }}-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-swift-${{ hashFiles('Package.swift') }}-
            ${{ runner.os }}-swift-
      
      - name: Resolve Swift Package Dependencies
        run: |
          if [ "${{ steps.swift-package-cache.outputs.cache-hit }}" == "true" ]; then
            echo "âœ… Cache hit! Using cached dependencies"
          else
            echo "ðŸ“¦ Cache miss. Resolving dependencies..."
          fi
          
          swift package resolve
          
          if [ -f Package.resolved ]; then
            echo "âœ… Dependencies resolved"
          fi
      
      - name: Build for iOS Simulator
        run: |
          echo "Building for iOS Simulator (arm64)..."
          xcrun swift build \
            -c release \
            -Xswiftc -sdk \
            -Xswiftc $(xcrun --show-sdk-path --sdk iphonesimulator) \
            -Xswiftc -target \
            -Xswiftc arm64-apple-ios16.0-simulator \
            --arch arm64
      
      - name: Run Tests on iOS Simulator
        run: |
          echo "Running tests for iOS Simulator..."
          xcrun swift test \
            --enable-code-coverage \
            --parallel \
            -Xswiftc -sdk \
            -Xswiftc $(xcrun --show-sdk-path --sdk iphonesimulator) \
            -Xswiftc -target \
            -Xswiftc arm64-apple-ios16.0-simulator \
            --arch arm64
      
      - name: Boot iOS Simulator
        run: |
          # List available simulators
          xcrun simctl list devices available
          # Boot iPhone 15 Pro if available
          xcrun simctl boot "iPhone 15 Pro" 2>/dev/null || \
          xcrun simctl boot "iPhone 14" 2>/dev/null || \
          echo "Simulator boot skipped"
      
      - name: Generate Test Report
        if: always()
        run: |
          echo "## âœ… Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests completed successfully" >> $GITHUB_STEP_SUMMARY
