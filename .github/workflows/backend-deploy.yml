name: Backend Deployment

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment (staging/production)'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  deploy:
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          find . -name "requirements.txt" -exec pip install -r {} \;
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: Run database migrations
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "cd /opt/arcode/backend && \
             source venv/bin/activate && \
             python -m database.migrate --env ${{ github.event.inputs.environment || 'staging' }}"
        continue-on-error: false
      
      - name: Deploy backend code
        run: |
          rsync -avz --delete \
            --exclude 'venv/' \
            --exclude '__pycache__/' \
            --exclude '*.pyc' \
            --exclude '.env' \
            backend/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/arcode/backend/
      
      - name: Install Python dependencies on server
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "cd /opt/arcode/backend && \
             source venv/bin/activate && \
             pip install --upgrade pip && \
             pip install -r requirements.txt && \
             find . -name 'requirements.txt' -exec pip install -r {} \;"
      
      - name: Restart services
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "sudo systemctl restart arcode-api && \
             sudo systemctl restart rq-worker && \
             sudo systemctl restart nginx"
      
      - name: Health check
        run: |
          sleep 10
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              https://${{ secrets.SERVER_HOST }}/health || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Health check passed"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "‚è≥ Health check failed ($HTTP_CODE), retrying ($RETRY_COUNT/$MAX_RETRIES)..."
            sleep 5
          done
          
          echo "‚ùå Health check failed after $MAX_RETRIES attempts"
          exit 1
      
      - name: Rollback on failure
        if: failure()
        run: |
          echo "üîÑ Initiating rollback..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "cd /opt/arcode && \
             git checkout HEAD~1 -- backend/ && \
             sudo systemctl restart arcode-api && \
             sudo systemctl restart rq-worker"
          
          # Notify team
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d "{\"text\": \"üö® Deployment failed and rolled back\"}" || true
      
      - name: Deployment notification
        if: success()
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d "{\"text\": \"‚úÖ Backend deployed successfully to ${{ github.event.inputs.environment || 'staging' }}\"}" || true







